# Mozhi

Production-grade cross-platform voice bridge that captures speech on mobile, streams securely to desktop, transcribes locally with Faster-Whisper, risk-filters content, and injects text into Claude Desktop Cowork input.

## Project Structure

```text
.
├── desktop_agent/
│   └── mozhi_agent/
│       ├── audio/
│       ├── injection/
│       ├── observability/
│       ├── pipeline/
│       ├── risk/
│       ├── security/
│       ├── stt/
│       ├── ui/
│       ├── config.py
│       ├── main.py
│       └── models.py
├── mobile_app/
│   └── lib/
│       ├── models/
│       ├── screens/
│       └── services/
├── scripts/
│   ├── build_macos.sh
│   └── build_windows.ps1
├── .env.example
├── pyproject.toml
└── README.md
```

## Desktop Agent Setup

1. Install Python 3.11+.
2. Create virtual env and install dependencies:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -U pip
   pip install -e .
   ```
3. Copy `.env.example` to `.env` and set `MOZHI_ADVERTISED_HOST` to your desktop LAN IP.
4. Run agent:
   ```bash
   mozhi-agent
   ```

At startup the desktop prints an ASCII QR in terminal and writes `pairing_qr.png` for mobile pairing.

## Mobile App Setup (Flutter)

1. Install Flutter stable + platform SDKs.
2. In `mobile_app/`:
   ```bash
   flutter pub get
   flutter run
   ```
3. Tap **Pair Desktop via QR** and scan the desktop pairing QR.
4. Press and hold the mic button to stream encrypted PCM audio.

## Secure Pairing Flow

1. Desktop generates QR containing websocket endpoint + desktop public key.
2. Mobile scans QR and creates X25519 keypair.
3. Mobile sends pairing request (`device_id`, `device_name`, client public key).
4. Desktop derives shared key via X25519 and returns short-lived session token.
5. Mobile encrypts every audio packet with AES-GCM using shared key and sends over websocket.

## Runtime Pipeline

1. Mobile press-and-hold streams encrypted PCM chunks.
2. Desktop decrypts packet and sends chunk to Faster-Whisper.
3. Transcript confidence + latency are logged.
4. Risk filter checks destructive keywords: `delete`, `remove`, `overwrite`, `deploy`, `execute`, `run`, `drop`, `purge`.
5. If risky, confirmation dialog is required before injection.
6. Approved text is injected into Claude Desktop input and optionally Enter is pressed.

## Packaging Instructions

### Windows EXE

```powershell
./scripts/build_windows.ps1
```

Artifacts are generated by PyInstaller under `dist/`.

### macOS App Bundle

```bash
./scripts/build_macos.sh
```

Artifacts are generated by py2app under `dist/`.

## Observability

- Structured JSON logs via `structlog`
- Audit log at `MOZHI_ACTION_LOG_PATH`
- Transcript confidence and latency are tracked per chunk
- `MOZHI_DEBUG=true` for verbose diagnostics

## Security Notes

- No plaintext audio streaming
- AES-GCM packet encryption
- X25519 key agreement for pairing
- Session token expiry enforced server-side
- Local-only speech-to-text (no cloud dependency)

## Phase 2 Upgrade Plan (Design Only)

Bidirectional voice support: Claude response readout to mobile.

### Components

1. **Desktop Response Capture**
   - Detect latest Claude response text region via accessibility APIs.
   - Use event-driven hooks to avoid polling where possible.
2. **Desktop TTS Service**
   - Local TTS engine abstraction (macOS `NSSpeechSynthesizer`, Windows SAPI, optional Coqui).
   - Chunk response into sentence units for low-latency streaming.
3. **Secure Downlink Stream**
   - Reuse paired session key + token.
   - Add `tts_audio` event type over same encrypted channel.
4. **Mobile Playback Buffer**
   - Jitter buffer and audio output controls (pause/skip/repeat).
   - Optional barge-in: cancel playback when user starts push-to-talk.
5. **Policy Layer**
   - Per-workspace controls (disable TTS for sensitive sessions).
   - Audit response playback events.

### NFR Targets

- First audio byte under 700 ms after Claude response completion
- Maintain encrypted transport and token auth parity with uplink path
- Preserve <2 s end-to-end for user speech-to-text injection path
